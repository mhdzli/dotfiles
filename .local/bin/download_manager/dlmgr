#!/bin/bash

# Set the menu for choosing options
menu="$MENU -p"
# Set the path for file lists whitch dlmgr use
a2_dir="$HOME/.local/share/aria2"
# Set the default path for download files
dl_dir="$HOME/Downloads"

# Set the clipboard based on the display manager (Xorg or Wayland)
[ -z "$WAYLAND_DISPLAY" ]  && pf="xorg" || pf="wayland"
xclip -h 2>/dev/null || [ -n "$WAYLAND_DISPLAY" ] || exit
wl-copy -h >/dev/null || [ -z "$WAYLAND_DISPLAY" ] || exit

# Make the dlmgr if it doesn't exist already
[ -d "$a2_dir" ] || mkdir -p "$a2_dir"

start_download () {
    # Remove empty lines in dl_list
    sed -i '/^[ \t]*$/d' "$a2_dir"/dl_list
    progress_model=$(printf "Terminal\nNotification\nDon't Show" | $menu "How do you like to see your download progress? ")
    case "$progress_model" in
        "Terminal")
            exec-terminal aria2c -c -x 16 -s 16 -k 1M -i "$a2_dir"/dl_list -j 1 \
                --on-download-start="dl_nf_start" \
                --on-download-complete="dl_nf_complete"\
                --on-download-error="dl_nf_error"
            ;;
        "Notification")
            aria2c -c -x 16 -s 16 -k 1M -i "$a2_dir"/dl_list -j 1 \
                --on-download-start="dl_nf_start" \
                --on-download-complete="dl_nf_complete"\
                --on-download-error="dl_nf_error"\
                --summary-interval=1 2>&1 | while read -r line; do
                    report=$(echo "$line" | grep -oP "\[.*\([0-9]*%\).*\]")
                    progress=$(echo "$report" | grep -oP "[0-9]*%")
                    [ -n "$report" ] && notify-send -r 2224 -h int:value:"$progress" -i "$HOME/.local/bin/download_manager/download.svg" "Downloading ..." "$report"
                done
            ;;
        *)
            aria2c -c -x 16 -s 16 -k 1M -i "$a2_dir"/dl_list -j 1 \
                --on-download-start="dl_nf_start" \
                --on-download-complete="dl_nf_complete"\
                --on-download-error="dl_nf_error"
            ;;
    esac
}

stop_download () {
    dl_pid=$(pgrep "aria2c" | awk 'NR==1{print $1}')
    notify-send -r 2225 -i "$HOME/.local/bin/download_manager/pause.svg" "Pausing your aria2c downloads" "You can resume your downloads by starting dlmgr again"
    # kill with SIGTERM, allowing finishing touches.
    while [ -n "$dl_pid" ]; do
        kill -15 "$dl_pid"
        # even after SIGTERM, aria2 may still run, so SIGKILL it.
        sleep 3
        kill -9 "$dl_pid"
        dl_pid=$(pgrep "aria2c" | awk 'NR==1{print $1}')
    done
    exit
}

add_link () {
    case $pf in
        "xorg") links=$(xclip -o);;
        "wayland") links=$(wl-paste);;
    esac
    selected_link=$(printf 'All\n%s' "$links" | $menu "Select The Url Address: ")
    [ "$selected_link" ] && dir="$(find "$HOME" -maxdepth 5 -type d 2>/dev/null | $menu "Type in download directory.")" || dir="$dl_dir"
    [ "$dir" ] && if [ "$selected_link" == "All" ]; then
        echo "$links" | while read -r line; do
            dlmgr add "$line" "$dir"
        done
    else
        dlmgr add "$selected_link" "$dir"
    fi
    ask_action
}

remove_link () {
    line=$(grep -n "^[^ ]" "$a2_dir"/dl_list | $menu "Url Address" | cut -d: -f1)
    # Remove the selected line (download url) and the next line after (download path)
    sed -i "${line},+1d" "$a2_dir"/dl_list
    stop_download && ask_action
}

ask_action () {
    choice="$(printf "Start Download\nStop Download\nAdd Link\nRemove Link\nExit" | $menu "What do you want to do?")" || exit 1
    case $choice in
        "Start Download") start_download;;
        "Stop Download") stop_download;;
        "Add Link") add_link;;
        "Remove Link") remove_link;;
        "Exit") exit 0;;
        *)
            notify-send -r 2225 -i "$HOME/.local/bin/download_manager/error.svg" "Exit with error" "Not a valid option"
            exit 1
            ;;
    esac
}

case $1 in
    add) [ "${3}" ] && printf "%s\n    dir=%s\n" "$2" "$3" >> "$a2_dir"/dl_list || printf "\n%s\n    dir=%s" "$2" "$dl_dir"  >> "$a2_dir"/dl_list;;
    remove) remove_link;;
    stop) stop_download;;
    start) start_download;;
    *) ask_action;;
esac
